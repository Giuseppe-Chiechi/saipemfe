@page "/workflow/certificate/energy-source-isolation/detail/{Id:int}/{Certificate:int}"
@* @page "/workflow/certificate/energy-source-isolation/detail/{Id:int}" *@
@inherits SaipemE_PTW.Components.Base.CommonComponentBase
@implements IDisposable
@inject IPermessoLavoroService PermessiService
@using SaipemE_PTW.Components.Workflow
@using SaipemE_PTW.Components.Workflow.Detail
@using SaipemE_PTW.Services.Workflow.PWT
@using SaipemE_PTW.Shared.Models.Auth
@using SaipemE_PTW.Validators.Workflow.PWT.CaldoGenerico
@using System.Text.Json
@attribute [Authorize]

<PageTitle>@_pageTitle</PageTitle>

<SaipemE_PTW.Components.Common.Alert Tipo="@AlertTipo" Message="@AlertMessage" Visible="@AlertShow" VisibleChanged="@(v => AlertShow = v)"></SaipemE_PTW.Components.Common.Alert>

<MudMessageBox @ref="_mudMessageBox" Title="Attenzione" CancelText="Cancel">
    <MessageContent>
        Vuoi confermare l'operazione?
    </MessageContent>
    <YesButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success">Conferma!</MudButton>
    </YesButton>
</MudMessageBox>


<MudForm @ref="_form1">
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mx-auto px-2" Style="overflow-x: hidden;">


        <MudBreadcrumbs Items="_BreadcrumbItems"></MudBreadcrumbs>


        <MudGrid Spacing="3" Class="TitleBox">
            <MudItem>
                <MudText Typo="Typo.h4" Class="text-slate-800 font-bold">
                    @_pageTitle
                </MudText>
            </MudItem>
        </MudGrid>


        <MudItem xs="12">


            <MudCard Class="mud-width-full mb-4">
                <MudCardContent>

                    @if (Id != null && _model._timeline != null)
                    {
                        <SaipemE_PTW.Components.Common.Timeline tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" Steps="@_model._timeline"></SaipemE_PTW.Components.Common.Timeline>
                    }

                    <SaipemE_PTW.Components.Workflow.Certificati.IsolamentoFontiEnergetico.Detail.DataDetail tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" @bind-Model="_model" pageTitle="@_pageTitle" /> 
                   @*  <DataDetail tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" @bind-Model="_model" pageTitle="@_pageTitle" /> *@
                </MudCardContent>
            </MudCard>

            <MudTabs Elevation="2" Rounded="true"
                     ApplyEffectsToContainer="true" PanelClass="pa-6 mud-width-full"
                     ActivePanelIndexChanged="OnTabChanged">

                <SaipemE_PTW.Components.Workflow.Detail.Parte1.Parte1 tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyParte1="@_isReadOnlyParte1" @bind-Model="_model" />


                @if (Id != null && !(userRole.Equals(UserRole.AutoritaRichiedente)
                                || userRole.Equals(UserRole.AutoritaEsecutrice) 
                                || userRole.Equals(UserRole.EspertoQualificatoEQ)
                                || userRole.Equals(UserRole.AmministratoreSistema)
                ))
                {

                    <SaipemE_PTW.Components.Workflow.Detail.Parte2.Parte2 tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyParte2="@_isReadOnlyParte2" @bind-Model="_model" />

                }

                @if (Id != null && !(userRole.Equals(UserRole.AutoritaRichiedente)
                                || userRole.Equals(UserRole.AutoritaEsecutrice)
                                || userRole.Equals(UserRole.AutoritaEmittente)
                                || userRole.Equals(UserRole.PTWCoordinator) 
                                || userRole.Equals(UserRole.EspertoQualificatoEQ) 
                                || userRole.Equals(UserRole.AmministratoreSistema)))
                {
                    <SaipemE_PTW.Components.Workflow.Detail.CSE.CSE tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyParteCSE="@_isReadOnlyParteCSE" @bind-Model="_model" />

                }

                @if (Id != null && !(userRole.Equals(UserRole.AutoritaRichiedente)
                                || userRole.Equals(UserRole.AutoritaEsecutrice)
                                || userRole.Equals(UserRole.AutoritaEmittente)
                                || userRole.Equals(UserRole.PersonaAutorizzataTestGas)
                                || userRole.Equals(UserRole.CoordinatoreInEsecuzioneCSE)
                                || userRole.Equals(UserRole.PTWCoordinator)
                                || userRole.Equals(UserRole.EspertoQualificatoEQ)))
                {

                    <SaipemE_PTW.Components.Workflow.Detail.Parte3.Parte3 tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyParte3="@_isReadOnlyParte3" @bind-Model="_model" />



                }



               @*  @if (Id != null && (userRole.Equals(UserRole.AutoritaEsecutrice)
                                || userRole.Equals(UserRole.AutoritaOperativa)
                                || userRole.Equals(UserRole.SuperOwner)
                                || userRole.Equals(UserRole.Visitatore)))
                {
                    <SaipemE_PTW.Components.Workflow.Detail.Rinnovo.Rinnovo tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyRinnovo="@_isReadOnlyRinnovo" @bind-Model="_model" />

                } *@


               @*  @if (Id != null && (userRole.Equals(UserRole.AutoritaEsecutrice)
                                || userRole.Equals(UserRole.AutoritaOperativa)
                                || userRole.Equals(UserRole.PTWCoordinator)
                                || userRole.Equals(UserRole.SuperOwner)
                                || userRole.Equals(UserRole.Visitatore)))
                {
                    <SaipemE_PTW.Components.Workflow.Detail.Sospensione.Sospensione tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlySospensione="@_isReadOnlySospensione" @bind-Model="_model" />

                } *@

              @*   @if (Id != null && (userRole.Equals(UserRole.PTWCoordinator) 
                || userRole.Equals(UserRole.SuperOwner) 
                                || userRole.Equals(UserRole.Visitatore)))
                {

                    <SaipemE_PTW.Components.Workflow.Detail.Riattivazione.Riattivazione tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyRiattivazione="@_isReadOnlyRiattivazione" @bind-Model="_model" />

                } *@

                @if (Id != null && (userRole.Equals(UserRole.AutoritaEsecutrice)
                                || userRole.Equals(UserRole.AutoritaOperativa)
                                
                                || userRole.Equals(UserRole.SuperOwner) 
                                || userRole.Equals(UserRole.Visitatore)))
                {

                    <SaipemE_PTW.Components.Workflow.Detail.Chiusura.Chiusura tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyChiusura="@_isReadOnlyChiusura" @bind-Model="_model" />

                }




            </MudTabs>

            <!-- TAB -->
            <MudGrid Class="mt-4">
                <MudItem xs="12">
                    <MudExpansionPanels MultiExpansion="true">

                        <SaipemE_PTW.Components.Workflow.Detail.Allegati.AllegatiPanel tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyAllegati="@_isReadOnlyAllegati"
                                                                                       @bind-Model="_model" />

                        <SaipemE_PTW.Components.Workflow.Detail.Certificati.CertificatiPanel tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyCertificati="@_isReadOnlyCertificati"
                                                                                             @bind-Model="_model" />
                        <SaipemE_PTW.Components.Workflow.Detail.GasTest.GasTestPanel tipoPDL="TipoPDL.PermessoLavoroGenericoCaldo" _isReadOnlyGasTest="@_isReadOnlyGasTest"
                                                                                     @bind-Model="_model"  />
                   
                    </MudExpansionPanels>
                </MudItem>
            </MudGrid>


            <!-- BOTTONI -->
            <MudCard Class="mud-width-full mt-4">
                <MudCardContent>
                    <MudGrid Class="mt-4">
                        <MudItem xs="12" sm="6">
                            <MudButtonGroup Color="Color.Primary" Variant="Variant.Filled" Style="float:left" OverrideStyles="false">

                                <MudButton  OnClick="SubmitAnnulla" StartIcon="@Icons.Material.Filled.CancelPresentation" Color="Color.Default" Variant="Variant.Filled">Esci</MudButton>

                                <MudButton  OnClick="SubmitStampa" StartIcon="@Icons.Material.Filled.Print" Color="Color.Primary" Variant="Variant.Filled">Stampa</MudButton>
                                <MudButton Disabled="@_isReadOnly" OnClick="SubmitSalvaBozze" StartIcon="@Icons.Material.Filled.Save" Color="Color.Tertiary" Variant="Variant.Filled">Salva in bozza</MudButton>
                            </MudButtonGroup>
                        </MudItem>

                        <MudItem xs="12" sm="6">
                            <MudButtonGroup  Color="Color.Primary" Variant="Variant.Filled" Style="float:right" OverrideStyles="false">


                                @if (!userRole.Equals(UserRole.AutoritaRichiedente) &&
                                                                !(tabActive.Equals(TipoTabPWT.Chiusura) ||
                                                                tabActive.Equals(TipoTabPWT.Riattivazione)
                                                                || tabActive.Equals(TipoTabPWT.Sospensione)
                                                                || tabActive.Equals(TipoTabPWT.Rinnovo)
                                                                || userRole.Equals(UserRole.Visitatore)))
                                {
                                    <MudButton Disabled="@_isReadOnly"  OnClick="SubmitRigetta" StartIcon="@Icons.Material.Filled.Save" Color="Color.Secondary" Variant="Variant.Filled">Rigetta</MudButton>
                                }
                                <MudButton Disabled="@_isReadOnly" OnClick="SubmitFirma" StartIcon="@Icons.Material.Filled.AssignmentTurnedIn" Color="Color.Warning" Variant="Variant.Filled">Firma</MudButton>
                                <MudButton Disabled="@_isReadOnly" OnClick="SubmitInoltro" StartIcon="@Icons.Material.Filled.ForwardToInbox" Color="Color.Success" Variant="Variant.Filled">Inoltra</MudButton>
                            </MudButtonGroup>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>


        </MudItem>



    </MudContainer>
</MudForm>


@code {


    [Parameter]
    [SupplyParameterFromQuery]
    public int? Id { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public int? Certificate { get; set; }


}

