@inherits SaipemE_PTW.Components.Base.CommonComponentBase
@implements IDisposable
@using SaipemE_PTW.Shared.Models.PWT

@if (Model is null)
{
    <MudPaper Class="p-4">
        <MudText Typo="Typo.subtitle2">Dati del permesso non disponibili.</MudText>
    </MudPaper>
}
else
{
    <MudField Label="Dettaglio permesso lavoro" Variant="Variant.Outlined" Class="mb-3 mt-4">
        <MudGrid Class="mt-4">
            <MudItem xs="12">


                <MudGrid Class="mb-3">

                    @if (Model.id != null)
                    {
                        <MudItem xs="12" sm="3">
                            <MudTextField class="text-orange" Label="Nr. permesso (PdL):" Disabled="true" Value="@Model.pdl" />
                        </MudItem>

                        <MudItem xs="12" sm="3">
                            <MudTextField Label="Certificato:" Disabled="true" Value="@Model.Certificato" />
                        </MudItem>

                        <MudItem xs="12" sm="3">
                            <MudTextField Label="Data inizio lavori:" Disabled="true" Value="@($"{Model?.DataInizioLavori}")" />
                        </MudItem>

                        <MudItem xs="12" sm="3">
                            <MudTextField Label="Data fine lavori:" Disabled="true" Value="@($"{Model?.DataFineLavori}")" />
                        </MudItem>

                        <MudItem xs="12" sm="4">
                            @{
                                var Stato = Model?.Stato?.Nome ?? "Nuovo permesso";
                            }
                            <MudTextField Label="Stato del PdL (*):" Value="@Stato" Disabled="true" />
                        </MudItem>
                    }

                    

                    <MudItem xs="12" sm="4">
                        @{
                            var Sito = Model?.Sito ?? "Ravenna";
                        }

                        <MudTextField Label="Sito (*):" Disabled="true" Value="@Sito" />
                    </MudItem>

                    <MudItem xs="12" sm="4">
                        @{
                            var Tipo = Model?.Tipo?.Nome ?? pageTitle;
                            //var Tipo = pageTitle;
                        }
                        @if (Model?.id == null)
                        {
                            SelectedUrl = Tipo;

                            <MudSelect T="string"
                                       @bind-Value="SelectedUrl"
                                       @bind-Value:after="OnUrlSelected"
                                       Placeholder="Seleziona" Label="Tipo Permesso di Lavoro"
                                       Dense="true"
                                       Clearable="true">


                                @foreach (var state in TipoPDLMapper.GetAll())
                                {
                                    var url = state.Url + "detail";
                                    <MudSelectItem Value="@url">@state.Nome</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudTextField Disabled="true" Label="Tipo:" Value="@Tipo" />
                        }



                    </MudItem>





                </MudGrid>
                @if (Model.id != null)
                {
                    <MudGrid Class="mb-3 justify-end">
                        <MudItem>
                            <MudButton Variant="Variant.Filled"
                                       StartIcon="@Icons.Material.Filled.PendingActions"
                                       Size="Size.Small"
                                       Color="Color.Default"
                                       OnClick="OpenCronologiaAsync">
                                Cronologia
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                }

            </MudItem>
        </MudGrid>
    </MudField>
}


@code {

    [Parameter] public PermessoLavoroModel? Model { get; set; }
    [Parameter] public EventCallback<PermessoLavoroModel> ModelChanged { get; set; }
    [Parameter] public string? pageTitle { get; set; }
    [Parameter] public TipoPDL TipoPDL { get; set; }

    private string? SelectedUrl;

    private CronologiaPermessoLavoro? _cronologiaSelezionata;

    private async Task OpenCronologiaAsync()
    {
        var options = new MudBlazor.DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MudBlazor.MaxWidth.Large,
            FullWidth = true,
            CloseButton = true,
        };

        var parameters = new DialogParameters
        {
            //_isReadOnlyCronologia = true
        };

        var dialog = await DialogService.ShowAsync<CronologiaDialog>(
                "Cronologia",
                parameters,
                options
            );

        //var dialog = DialogService.Show<CronologiaDialog>("Cronologia", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is CronologiaPermessoLavoro selected)
        {
            _cronologiaSelezionata = selected;
            ApplyCronologiaSelection(selected);
            StateHasChanged();
        }
    }

    // Mappatura dei campi dal record selezionato verso il componente padre.
    // Personalizza questa funzione quando specificherai i campi da riempire.
    private void ApplyCronologiaSelection(CronologiaPermessoLavoro selected)
    {
        // Esempio di mappature possibili (commentate finché non confermi i target):
        // _model.AutoritaEsecutriceNome = selected.Nome;
        // _model.AutoritaEsecutriceCognome = selected.Cognome;
        // _model.AutoritaEsecutriceFirma = $"{selected.Nome} {selected.Cognome}";
        // _model.AutoritaEsecutriceData = selected.Data;
        // _model.AutoritaEsecutriceOra = selected.Ora;
        // etc.
    }



    private void OnUrlSelected()
    {
        if (!string.IsNullOrWhiteSpace(SelectedUrl))
            Navigation.NavigateTo(SelectedUrl);
    }



}
